<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор Друкованих Форм A6 (Smart Sort & Print)</title>
    <!-- Завантаження Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Завантаження Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Налаштування шрифту Times New Roman та стилі для друку --><style>
        /* Шрифт Times New Roman для друкованої форми */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif; /* Inter залишаємо для інтерфейсу */
            background-color: #f3f4f6;
        }
        
        /* Спеціальні стилі для друку */
        @media print {
            /* Приховуємо все, крім області друку */
            body > *:not(.print-only) {
                display: none;
            }
            .print-only {
                display: block !important;
                margin: 0;
                padding: 0;
                /* Встановлюємо Times New Roman для всієї області друку */
                font-family: 'Times New Roman', serif !important; 
            }
            /* Стиль для всієї сторінки A4 - ДИНАМІЧНА СІТКА A6 (2x2) */
            .a4-page {
                width: 210mm; /* A4 width */
                height: 296mm; /* A4 height (трохи менше 297 для запобігання пустих сторінок) */
                margin: 0;
                padding: 0;
                display: grid;
                /* Фіксовані розміри для 2х колонок */
                grid-template-columns: repeat(2, 105mm);
                /* grid-template-rows: буде встановлено динамічно! */ 
                overflow: hidden;
                page-break-after: always; /* Завжди розрив після сторінки A4 */
            }
            .a4-page:last-child {
                page-break-after: auto;
            }

            /* Стиль для окремої форми A6 */
            .a6-form {
                width: 105mm; 
                /* Висота буде встановлена через клас або динамічно! */
                page-break-inside: avoid; /* Запобігає розриву форми на сторінці */
                border: 1px solid #000;
                box-sizing: border-box;
                padding: 5px; 
                background-color: white;
                font-size: 9pt !important; 
                position: relative;
                font-family: 'Times New Roman', serif !important;
            }
            /* Налаштування рамок для точного 2x2 макета */
            .a6-form:nth-child(odd) { border-left: none; }
            .a6-form:nth-child(even) { border-right: none; }
            .a6-form:nth-child(-n+2) { border-top: none; }
            
            /* Специфічна логіка для border-bottom видалена, бо тепер висота динамічна */
            /* Але ми можемо спробувати прибрати нижній бордер для верхнього рядка візуально, якщо треба */
            /* .a6-form:nth-child(n+3) { border-bottom: none; } - Це може бути небезпечно при переносі */
            
            /* Нові динамічні висоти для форм */
            .a6-form.h-zak { height: 126.225mm !important; } /* 148.5 * 0.85 */
            .a6-form.h-bio { height: 168mm !important; } /* 148.5 * 1.15 */
            .a6-form.h-std { height: 148.5mm !important; } /* Стандарт A6 */

            /* Стиль Times New Roman 6pt для шапки */
            .print-header-style {
                font-family: 'Times New Roman', serif !important;
                font-size: 6pt !important; 
                line-height: 1.2;
                font-weight: normal !important; /* Прибрати жирний шрифт */
            }
            /* Стиль для відображення фіксованої назви закладу з переносами рядків */
            .institution-name-print {
                white-space: pre-wrap;
                line-height: 1.1;
                font-size: 7pt;
            }

            /* Стиль для динамічних даних - жирний та підкреслений */
            .print-data {
                font-weight: bold !important; 
                text-decoration: underline;
                display: inline;
                font-size: 9pt !important;
            }
            
            /* Стиль для статичних підписів у формі */
            .form-label-print {
                font-size: 9pt !important;
                line-height: 1.3;
                font-weight: normal !important; /* Прибрати жирний шрифт */
            }
            .form-line {
                margin-top: 10px; /* Збільшення інтервалу між рядками */
            }
            /* Стиль для підпису лікаря внизу */
            .doctor-signature-line {
                display: inline-block;
                width: 100px; /* Залишаємо для відступу */
                text-align: center;
                margin-left: 2px;
            }
            /* Стилі для поля вводу в друкованій формі (якщо потрібно місце для заповнення) */
            .print-field {
                border-bottom: 1px solid #000;
                display: inline-block;
                min-width: 30px; 
                line-height: 1.3;
                font-size: 9pt !important;
                vertical-align: top;
                padding: 0 2px;
                box-sizing: border-box;
                font-weight: normal !important;
            }
            
            /* Специфічний стиль для таблиці Біохімії (4 колонки - 2x2) */
            .biochem-table-small {
                /* Дві колонки: одна для результату, друга для назви (2x2) */
                display: grid;
                grid-template-columns: 20px 1fr 20px 1fr; 
                border-top: 1px solid #000;
                border-left: 1px solid #000;
                margin-top: 5px; /* Ближче до діагнозу */
            }
            
            /* Специфічний стиль для таблиці Коагулограми та РМП (2 колонки - 1x1) */
            .coag-table, .rmp-table {
                display: grid;
                grid-template-columns: 20px 1fr; /* 1 колонка для даних */
                border-top: 1px solid #000;
                border-left: 1px solid #000;
                margin-top: 5px; /* Ближче до діагнозу */
            }

            .coag-table .coag-cell, .biochem-table-small .biochem-cell, .rmp-table .rmp-cell {
                border-right: 1px solid #000;
                border-bottom: 1px solid #000;
                padding: 1px;
                height: 15px; /* Зменшена висота рядка */
                line-height: 1.1;
                display: flex;
                align-items: center;
                box-sizing: border-box;
                font-size: 6pt !important; /* Шрифт 6pt для таблиці */
            }
            .coag-table .empty, .biochem-table-small .empty, .rmp-table .empty {
                justify-content: center;
                align-items: center;
            }
            .coag-table .coag-text, .biochem-table-small .biochem-text, .rmp-table .rmp-text {
                font-size: 6pt !important;
                line-height: 1.1;
            }
            /* Специфічні стилі для РМП - обмеження ширини */
            .rmp-table {
                width: 50%;
            }
        }

        /* Стилі для поля вводу в основному інтерфейсі */
        .form-input {
            @apply p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-sm;
        }
        .form-label {
            @apply text-sm font-medium text-gray-700 mb-1;
        }

        /* Додатковий стиль для клікабельних елементів списку */
        .patient-list-item {
            /* flex justify-between гарантує розміщення з боків */
            @apply flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-2 cursor-pointer transition duration-150 ease-in-out;
        }
        .patient-list-item:hover {
            @apply bg-indigo-50;
        }
        .patient-list-item.selected {
            @apply bg-indigo-100 border-indigo-500 border-2;
        }
        
        /* Стиль для імені пацієнта - ОНОВЛЕНО ДЛЯ МАКСИМАЛЬНОЇ ЖИРНОСТІ */
        .patient-name-display {
            @apply text-lg font-black text-gray-900 flex-grow truncate pr-4; 
            font-weight: 600 !important; /* Примусово ставимо максимальну жирність */
        }
    </style>
    <script>
        
        // --- Глобальний Стан ---
        let patients = {}; // { id: { pib, birthDate, ... } }
        let currentPatientId = null;
        let printQueue = []; // [{ patientData: {}, templateKey: 'ZAK', templateName: '...' }, ...]
        const PATIENT_STORAGE_KEY = 'lab_form_patients';

        // Перелік місяців для коректного відображення дати
        const monthNames = [
            'січня', 'лютого', 'березня', 'квітня', 'травня', 'червня',
            'липня', 'серпня', 'вересня', 'жовтня', 'листопада', 'грудня'
        ];
        
        // ФІКСОВАНІ ДАНІ ЗАКЛАДУ
        const FIXED_INSTITUTION_NAME = "КНП «Херсонська міська клінічна\nлікарня \nім. Є.Є. Карабелеша»";
        const SHORT_INSTITUTION_NAME = 'КНП "ХМКЛ ім. Є.Є. Карабелеша"'; 
        const FIXED_DEPARTMENT = "ВАІТ";
        
        // Список лікарів для синхронізації випадаючих списків
        const DOCTOR_OPTIONS = [
            "Воробйов К.Г.", "Туряниця С.В.", "Сидорко Ю.В.", "Ручкін В.С.", "Інший"
        ];

        // Нові розрахункові висоти в мм
        const H_STD = 148.5; // Стандарт A6
        const H_ZAK_ZAS = H_STD * 0.85; // ~126.225mm (ЗАК, ЗАС: зменшено на 15%)
        const H_BIO = H_STD * 1.15; // ~170.775mm (Біохімія: збільшено на 15%)

        const FORM_HEIGHTS = {
            'ZAK': { height: H_ZAK_ZAS, className: 'h-zak' },
            'ZAS': { height: H_ZAK_ZAS, className: 'h-zak' },
            'BIO': { height: H_BIO, className: 'h-bio' },
            'KOA': { height: H_STD, className: 'h-std' },
            'RMP': { height: H_STD, className: 'h-std' },
            'BLG': { height: H_STD, className: 'h-std' }, 
        };
        
        function getFormHeightInfo(key) {
            return FORM_HEIGHTS[key] || { height: H_STD, className: 'h-std' };
        }

        // --- ДОПОМІЖНІ ФУНКЦІЇ ДЛЯ УПРАВЛІННЯ ПАЦІЄНТАМИ ---
        function loadPatients() {
            try {
                const stored = localStorage.getItem(PATIENT_STORAGE_KEY);
                patients = stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error("Error loading patients from localStorage:", e);
                patients = {};
            }
        }

        function savePatients() {
            try {
                localStorage.setItem(PATIENT_STORAGE_KEY, JSON.stringify(patients));
            } catch (e) {
                console.error("Error saving patients to localStorage:", e);
            }
        }

        function captureFormData() {
            // Збирає дані з усіх основних полів форми
            const form = document.getElementById('entry-form');
            const genderRadio = form.querySelector('input[name="gender"]:checked');
            const leukoformulaRadio = form.querySelector('input[name="leukoformula"]:checked');

            return {
                pib: form.pib.value.trim(),
                birthDate: form.birthDate.value.trim(),
                age: form.age.value.trim(),
                gender: genderRadio ? genderRadio.value : '',
                address: form.address.value.trim(),
                doctor: form.doctor.value.trim(), // Doctor is read from the main form
                medCardNumber: form.medCardNumber.value.trim(),
                clinicalDiagnosis: form.clinicalDiagnosis.value.trim(),
                leukoformula: leukoformulaRadio ? leukoformulaRadio.value : 'yes', // 'yes' by default
            };
        }

        function loadDataToForm(data) {
            const form = document.getElementById('entry-form');
            form.pib.value = data.pib || '';
            form.birthDate.value = data.birthDate || '';
            form.age.value = data.age || '';
            form.address.value = data.address || '';
            form.medCardNumber.value = data.medCardNumber || '';
            form.clinicalDiagnosis.value = data.clinicalDiagnosis || '';
            
            // Set gender radio button
            const genderValue = data.gender || 'Ч';
            const genderRadio = form.querySelector(`input[name="gender"][value="${genderValue}"]`);
            if (genderRadio) genderRadio.checked = true;

            // Set leukoformula radio button
            const leukoformulaValue = data.leukoformula || 'yes';
            const leukoformulaRadio = form.querySelector(`input[name="leukoformula"][value="${leukoformulaValue}"]`);
            if (leukoformulaRadio) leukoformulaRadio.checked = true;

            // Doctor selection (if present in data, attempt to select it in main form and quick select)
            if (data.doctor) {
                form.doctor.value = data.doctor;
                document.getElementById('doctor-quick-select').value = data.doctor;
            }
        }

        function clearForm() {
            const form = document.getElementById('entry-form');
            form.pib.value = "";
            form.birthDate.value = "";
            form.age.value = "";
            form.address.value = "";
            form.medCardNumber.value = "";
            form.clinicalDiagnosis.value = "";
            
            // Reset gender/leukoformula
            form.querySelector('input[name="gender"][value="Ч"]').checked = true;
            form.querySelector('input[name="leukoformula"][value="yes"]').checked = true;
            
            // Keep date and doctor/leukoformula as they are usually current/fixed
            // If the quick select has a value, keep it. Otherwise, set to default.
            const quickDoctor = document.getElementById('doctor-quick-select').value || DOCTOR_OPTIONS[0];
            form.doctor.value = quickDoctor;
            
            // Clear currentPatientId when clearing form for a new patient
            currentPatientId = null; 
            document.getElementById('status-message').textContent = 'Введіть дані для нового пацієнта.';
            document.getElementById('status-message').className = 'mt-4 text-sm font-medium text-green-600 text-center';
        }

        window.renderPatientList = function() {
            const listContainer = document.getElementById('patient-list-container');
            listContainer.innerHTML = ''; // Очищаємо контейнер
            
            const patientKeys = Object.keys(patients).sort((a, b) => patients[a].pib.localeCompare(patients[b].pib));
            
            if (patientKeys.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 italic text-sm text-center pt-4">База пацієнтів порожня.</p>';
            }

            patientKeys.forEach(id => {
                const patient = patients[id];
                
                const itemDiv = document.createElement('div');
                // justify-between is critical here
                itemDiv.className = 'patient-list-item'; 
                if (currentPatientId === id) {
                    itemDiv.classList.add('selected');
                }

                // Вибір пацієнта кліком на область
                itemDiv.onclick = () => selectPatient(id);
                
                // 1. Ім'я (ЛІВОРУЧ) - ТЕПЕР ДУЖЕ ЖИРНИЙ ШРИФТ
                const nameSpan = document.createElement('span');
                nameSpan.className = 'patient-name-display'; 
                nameSpan.textContent = `${patient.pib} (${patient.birthDate || 'Н/Д'})`;

                // 2. Кнопки дій (ПРАВОРУЧ)
                const actionsDiv = document.createElement('div');
                // flex-shrink-0, щоб кнопки не стискались
                actionsDiv.className = 'flex space-x-2 flex-shrink-0 ml-2 items-center'; 
                
                // Кнопка Редагувати
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i data-lucide="edit-3" class="w-4 h-4 text-blue-600"></i>';
                editBtn.className = 'icon-button hover:bg-blue-100 p-1.5 rounded-md transition-colors'; 
                editBtn.title = 'Редагувати дані пацієнта';
                editBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    editSelectedPatient(id);
                };
                
                // Кнопка Видалити
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                deleteBtn.className = 'icon-button hover:bg-red-100 text-red-500 p-1.5 rounded-md transition-colors'; 
                deleteBtn.title = 'Видалити пацієнта';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deletePatient(id);
                };

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                
                // Додаємо елементи в правильному порядку
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(actionsDiv);
                listContainer.appendChild(itemDiv);
            });
            
            // Re-create lucide icons if needed
            lucide.createIcons();

            // Оновлення відображення обраного пацієнта
            if (currentPatientId && patients[currentPatientId]) {
                document.getElementById('current-patient-display').textContent = patients[currentPatientId].pib;
            } else {
                document.getElementById('current-patient-display').textContent = 'Не обрано';
            }
        }

        window.selectPatient = function(id) {
            if (id && patients[id]) {
                currentPatientId = id;
                loadDataToForm(patients[id]);
                document.getElementById('status-message').textContent = `Дані пацієнта ${patients[id].pib} завантажено.`;
                document.getElementById('status-message').className = 'mt-4 text-sm font-medium text-green-600 text-center';
                
                // 3. Секція "Заповнення Даних Пацієнта" СКРИТА
                document.getElementById('patient-data-section').classList.add('hidden');

            } else {
                // Новий пацієнт / Очистити форму
                clearForm();
                document.getElementById('status-message').textContent = 'Введіть дані для нового пацієнта.';
                
                // 3. Секція "Заповнення Даних Пацієнта" ПОКАЗАНА
                document.getElementById('patient-data-section').classList.remove('hidden');
            }
            renderPatientList();
        }
        
        window.editSelectedPatient = function(id) {
            if (id && patients[id]) {
                // Завантажуємо дані та показуємо форму
                selectPatient(id); 
                document.getElementById('patient-data-section').classList.remove('hidden');
                document.getElementById('status-message').textContent = `Редагування пацієнта ${patients[id].pib}.`;
                document.getElementById('status-message').className = 'mt-4 text-sm font-medium text-red-600 text-center';
            }
        }

        window.saveOrAddPatient = function() {
            const data = captureFormData();
            if (!data.pib || !data.birthDate || !data.age || !data.address) {
                document.getElementById('status-message').textContent = "Помилка: Необхідно заповнити ПІБ, дату народження, вік та адресу.";
                document.getElementById('status-message').classList.remove('text-green-600');
                document.getElementById('status-message').classList.add('text-red-600');
                return;
            }

            if (currentPatientId && patients[currentPatientId]) {
                // Update existing patient
                patients[currentPatientId] = { ...patients[currentPatientId], ...data };
                document.getElementById('status-message').textContent = `Дані пацієнта ${data.pib} оновлено.`;
            } else {
                // Add new patient
                const newId = 'pat-' + crypto.randomUUID();
                patients[newId] = data;
                currentPatientId = newId;
                document.getElementById('status-message').textContent = `Нового пацієнта ${data.pib} додано до бази.`;
            }

            savePatients();
            renderPatientList();
            
            // Після збереження приховуємо форму редагування
            window.selectPatient(currentPatientId);
            document.getElementById('status-message').classList.remove('text-red-600');
            document.getElementById('status-message').classList.add('text-green-600');
        }

        window.deletePatient = function(id) {
            if (id && patients[id]) {
                // Використовуємо prompt для імітації підтвердження
                const confirmation = prompt(`Щоб видалити пацієнта ${patients[id].pib}, введіть 'ТАК' (видалення без підтвердження через обмеження середовища):`);
                
                if (confirmation && confirmation.toUpperCase() === 'ТАК') { 
                    const name = patients[id].pib;
                    delete patients[id];
                    
                    if (currentPatientId === id) {
                        currentPatientId = null;
                        clearForm();
                    }
                    
                    savePatients();
                    renderPatientList();
                    document.getElementById('status-message').textContent = `Пацієнта ${name} видалено.`;
                    document.getElementById('status-message').classList.remove('text-red-600');
                    document.getElementById('status-message').classList.add('text-green-600');
                } else if (confirmation !== null) {
                    document.getElementById('status-message').textContent = `Видалення скасовано або введено неправильний код.`;
                    document.getElementById('status-message').classList.remove('text-green-600');
                    document.getElementById('status-message').classList.add('text-red-600');
                }
            }
        }
        
        // --- Doctor Quick Select Logic (ОНОВЛЕНО: Масове оновлення + LocalStorage) ---
        
        function initDoctorSelects() {
            const formSelect = document.getElementById('doctor');
            const quickSelect = document.getElementById('doctor-quick-select');
            
            // Clear existing options
            formSelect.innerHTML = '';
            quickSelect.innerHTML = '';
            
            // Add initial disabled option for the quick select
            const defaultQuickOption = document.createElement('option');
            defaultQuickOption.value = '';
            defaultQuickOption.textContent = '--- Швидкий вибір лікаря ---';
            defaultQuickOption.disabled = true;
            defaultQuickOption.selected = true;
            quickSelect.appendChild(defaultQuickOption);
            
            // Add options to both selects
            const defaultFormOption = document.createElement('option');
            defaultFormOption.value = '';
            defaultFormOption.textContent = '--- Оберіть лікаря ---';
            defaultFormOption.disabled = true;
            formSelect.appendChild(defaultFormOption);
            
            DOCTOR_OPTIONS.forEach(doc => {
                const opt1 = document.createElement('option');
                opt1.value = doc;
                opt1.textContent = doc;
                formSelect.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = doc;
                opt2.textContent = doc;
                quickSelect.appendChild(opt2);
            });
            
            // Set initial selected value for the form (if default patient/test data exists)
            formSelect.value = DOCTOR_OPTIONS[0]; // Set default for ease of testing
        }

        window.handleQuickDoctorChange = function(selectElement) {
            const newDoctor = selectElement.value;
            const formDoctor = document.getElementById('doctor');
            
            // 1. Оновлюємо поле у формі редагування (візуально)
            formDoctor.value = newDoctor;

            // 2. МАСОВЕ ОНОВЛЕННЯ: Оновлюємо лікаря для ВСІХ пацієнтів у базі
            const allPatientIds = Object.keys(patients);
            if (allPatientIds.length > 0) {
                allPatientIds.forEach(id => {
                    patients[id].doctor = newDoctor;
                });
                
                // 3. ЗБЕРІГАЄМО ЗМІНИ В LOCALSTORAGE
                savePatients();
                
                // Оновлюємо поточні дані форми, якщо пацієнт обраний (щоб при натисканні "Зберегти" не було конфліктів)
                if (currentPatientId && patients[currentPatientId]) {
                    loadDataToForm(patients[currentPatientId]);
                }
                
                document.getElementById('status-message').textContent = `Лікаря змінено на "${newDoctor}" для ВСІХ (${allPatientIds.length}) пацієнтів. Дані збережено локально.`;
            } else {
                document.getElementById('status-message').textContent = `Лікаря змінено на "${newDoctor}" (База пацієнтів порожня).`;
            }
            
            document.getElementById('status-message').classList.remove('text-red-600');
            document.getElementById('status-message').classList.add('text-green-600');
        }

        // --- Print Queue Management ---

        window.addToPrintQueue = function(templateKey) {
            const template = formTemplates[templateKey];
            if (!template) return;
            
            const formData = captureFormData();

            if (!formData.pib || !formData.doctor || !formData.age) {
                document.getElementById('status-message').textContent = "Помилка: Необхідно заповнити ПІБ, Лікаря та Вік перед додаванням аналізу.";
                document.getElementById('status-message').classList.remove('text-green-600');
                document.getElementById('status-message').classList.add('text-red-600');
                return;
            }

            // Capture the necessary fixed data and current form data
            const patientData = {
                ...formData,
                institutionName: FIXED_INSTITUTION_NAME,
                department: FIXED_DEPARTMENT,
                bioMaterialDay: document.getElementById('bioMaterialDay').value.trim(),
                bioMaterialMonth: document.getElementById('bioMaterialMonth').value.trim(),
                bioMaterialYear: document.getElementById('bioMaterialYear').value.trim(),
            };

            printQueue.push({ 
                patientData: patientData, 
                templateKey: templateKey,
                templateName: template.name
            });
            
            renderPrintQueue();
            document.getElementById('status-message').textContent = `Аналіз "${template.name}" для пацієнта ${formData.pib} додано до черги друку.`;
            document.getElementById('status-message').classList.remove('text-red-600');
            document.getElementById('status-message').classList.add('text-green-600');
        };

        window.undoQueue = function() {
            printQueue.pop();
            renderPrintQueue();
        };

        window.clearQueue = function() {
            printQueue = [];
            renderPrintQueue();
        };

        function renderPrintQueue() {
            const container = document.getElementById('selected-forms-container');
            const countDisplay = document.getElementById('selected-forms-count');
            container.innerHTML = '';
            countDisplay.textContent = printQueue.length;

            printQueue.forEach((item, index) => {
                const template = formTemplates[item.templateKey];
                const itemDiv = document.createElement('span');
                const textColor = item.templateKey === 'ZAS' ? 'text-gray-800' : 'text-white'; 
                const patientName = item.patientData.pib.split(' ')[0] || '...'; // Only use first name/word
                
                itemDiv.className = `${template.color} ${textColor} text-xs font-semibold px-2 py-1 rounded-full mr-2 mb-2 inline-block shadow-md transition duration-150 ease-in-out`;
                itemDiv.textContent = `${index + 1}. ${item.templateName} (${patientName})`;
                container.appendChild(itemDiv);
            });
            
            if (printQueue.length === 0) {
                container.innerHTML = '<p class="text-gray-400 italic text-sm">Черга друку порожня. Додайте аналізи для друку.</p>';
            }
        }
        
        // --- ДОПОМІЖНА ФУНКЦІЯ ДЛЯ ШАПКИ ---
        const getHeaderHTML = (institutionName) => `
            <div class="flex justify-between items-start mb-1 border-b border-black print-header-style">
                <div class="w-1/2 pr-2">
                    <p>Міністерство охорони здоров'я України</p>
                    <div class="mt-1">
                        <p class="border-b border-black">Найменування закладу</p>
                        <p class="institution-name-print border-b border-black">${institutionName}</p>
                        <p>Клініко-діагностична лабораторія</p>
                        <p class="text-[7pt] border-b-0"></p> <!-- Підкреслення прибрано -->
                    </div>
                </div>
                <div class="w-1/2 pl-2 border-l border-black leading-snug">
                    <p>МЕДИЧНА ДОКУМЕНТАЦІЯ</p>
                    <p>ФОРМА № 200/О</p>
                    <p class="mt-[2px]">Затверджена наказом МОЗ України</p>
                    <div class="flex items-center mt-[1px]">
                        <span class="border-b border-black mr-1">04.01.2011 р.</span>
                        <span>№</span>
                        <span class="border-b border-black px-1 ml-1">11</span>
                    </div>
                    <div class="mt-1"></div>
                </div>
            </div>
        `;
        
        // --- ДИНАМІЧНІ ШАБЛОНИ ФОРМ (HTML для A6) ---
        
        // Шаблон 1: ЗАК (Загальний Аналіз Крові) - Фіолетовий
        const templateZAK = (data, index) => {
            
            // Дата взяття біоматеріалу
            const bioDay = data.bioMaterialDay;
            const bioMonthIndex = parseInt(data.bioMaterialMonth) - 1;
            const bioMonthName = monthNames[bioMonthIndex] || '';
            const bioYear = data.bioMaterialYear;
            
            // Обробка лейкоформули
            const leukoformulaPrint = data.leukoformula === 'yes' ? 'ТАК' : 'НІ';

            return `
            <div class="a6-form border-none relative leading-tight">
                <div class="absolute top-[3mm] left-[5mm] right-[5mm]">
                    ${getHeaderHTML(data.institutionName)}

                    <div class="text-center mt-3 mb-2">
                        <p class="mt-1 form-label-print">
                            «<span class="print-field inline w-4 text-center border-none">${bioDay}</span>» <span class="print-field inline w-10 text-center border-none">${bioMonthName}</span> <span class="print-field inline w-8 text-center border-none">${bioYear}</span> р.
                        </p>
                        <p class="text-[7pt] italic">(дата взяття біоматеріалу)</p>
                    </div>
                    
                    <!-- Рядок ПІБ: Підпис + Дані (Жирний, Підкреслений) -->
                    <p class="mt-2 form-label-print form-line">
                        Прізвище,ім'я, по батькові
                        <span class="print-data ml-1">${data.pib}</span>
                    </p>
                    

                    <!-- Дата народження -->
                    <p class="form-label-print form-line">
                        Дата народження (число, місяць, рік)
                        <span class="print-data ml-1">${data.birthDate}</span>
                    </p>
                    
                    <!-- Вік та Стать -->
                    <p class="form-label-print form-line">
                        Вік (повних років) 
                        <span class="print-data ml-1">${data.age}</span> 
                        <span class="ml-2">стать:</span>
                        <span class="print-data ml-1">${data.gender}</span>
                    </p>
                    
                    <!-- Домашня адреса -->
                    <p class="form-label-print form-line">
                        Домашня адреса 
                        <span class="print-data ml-1">${data.address}</span>
                    </p>
                    
                    <!-- Заклад (ФІКСОВАНИЙ ТА СКОРОЧЕНИЙ) -->
                    <p class="form-label-print form-line">
                        Заклад 
                        <span class="print-data ml-1">${SHORT_INSTITUTION_NAME}</span>
                    </p>
                    
                    <!-- Відділення (ФІКСОВАНЕ) -->
                    <p class="form-label-print form-line">
                        Відділення 
                        <span class="print-data ml-1">${data.department}</span>
                    </p>
                    
                    <!-- Лікар -->
                    <p class="form-label-print form-line">
                        Лікар 
                        <span class="print-data ml-1">${data.doctor || ''}</span>
                    </p>
                    
                    <!-- Медична карта № -->
                    <p class="form-label-print form-line">
                        Медична карта № 
                        <span class="print-data ml-1">${data.medCardNumber || ''}</span>
                    </p>
                    
                    <!-- Клінічний діагноз -->
                    <p class="form-label-print form-line">
                        Клінічний діагноз 
                        <span class="print-data ml-1">${data.clinicalDiagnosis || ''}</span>
                    </p>
                    
                    <!-- Вид дослідження -->
                    <p class="form-label-print form-line">
                        Вид дослідження: 
                        <span class="print-data ml-1">ЗАГАЛЬНИЙ АНАЛІЗ КРОВІ</span>
                    </p>

                    <!-- Лейкоформула -->
                    <div class="mt-2 flex items-center form-label-print form-line">
                        <p class="mr-2">ЛЕЙКОФОРМУЛА:</p>
                        <span class="print-data">${leukoformulaPrint}</span>
                    </div>
                    
                    <!-- Підпис лікаря (АВТОМАТИЧНО З ПОЛЯ ЛІКАР) -->
                    <p style="font-size: 10pt !important; margin-top: 2px;">
                        П.І.Б. лікаря 
                        <span class="print-data" style="font-size: 10pt !important;">${data.doctor || ''}</span> 
                        <span class="doctor-signature-line"></span> <!-- Залишаємо відступ -->
                    </p>
                </div>
            </div>
            `;
        };

        // Шаблон 2: ЗАС (Загальний Аналіз Сечі) - Жовтий - ОНОВЛЕНИЙ
        const templateZAS = (data, index) => {
            
            // Дата взяття біоматеріалу
            const bioDay = data.bioMaterialDay;
            const bioMonthIndex = parseInt(data.bioMaterialMonth) - 1;
            const bioMonthName = monthNames[bioMonthIndex] || '';
            const bioYear = data.bioMaterialYear;
            
            return `
            <div class="a6-form border-none relative leading-tight">
                <div class="absolute top-[3mm] left-[5mm] right-[5mm]">
                    ${getHeaderHTML(data.institutionName)}

                    <div class="text-center mt-3 mb-2">
                        <p class="mt-1 form-label-print">
                            «<span class="print-field inline w-4 text-center border-none">${bioDay}</span>» <span class="print-field inline w-10 text-center border-none">${bioMonthName}</span> <span class="print-field inline w-8 text-center border-none">${bioYear}</span> р.
                        </p>
                        <p class="text-[7pt] italic">(дата взяття біоматеріалу)</p>
                    </div>
                    
                    <!-- Рядок ПІБ: Підпис + Дані (Жирний, Підкреслений) -->
                    <p class="mt-2 form-label-print form-line">
                        Прізвище,ім'я, по батькові
                        <span class="print-data ml-1">${data.pib}</span>
                    </p>
                    

                    <!-- Дата народження -->
                    <p class="form-label-print form-line">
                        Дата народження (число, місяць, рік)
                        <span class="print-data ml-1">${data.birthDate}</span>
                    </p>
                    
                    <!-- Вік та Стать -->
                    <p class="form-label-print form-line">
                        Вік (повних років) 
                        <span class="print-data ml-1">${data.age}</span> 
                        <span class="ml-2">стать:</span>
                        <span class="print-data ml-1">${data.gender}</span>
                    </p>
                    
                    <!-- Домашня адреса -->
                    <p class="form-label-print form-line">
                        Домашня адреса 
                        <span class="print-data ml-1">${data.address}</span>
                    </p>
                    
                    <!-- Заклад (ФІКСОВАНИЙ ТА СКОРОЧЕНИЙ) -->
                    <p class="form-label-print form-line">
                        Заклад 
                        <span class="print-data ml-1">${SHORT_INSTITUTION_NAME}</span>
                    </p>
                    
                    <!-- Відділення (ФІКСОВАНЕ) -->
                    <p class="form-label-print form-line">
                        Відділення 
                        <span class="print-data ml-1">${data.department}</span>
                    </p>
                    
                    <!-- Лікар -->
                    <p class="form-label-print form-line">
                        Лікар 
                        <span class="print-data ml-1">${data.doctor || ''}</span>
                    </p>
                    
                    <!-- Медична карта № -->
                    <p class="form-label-print form-line">
                        Медична карта № 
                        <span class="print-data ml-1">${data.medCardNumber || ''}</span>
                    </p>
                    
                    <!-- Клінічний діагноз -->
                    <p class="form-label-print form-line">
                        Клінічний діагноз 
                        <span class="print-data ml-1">${data.clinicalDiagnosis || ''}</span>
                    </p>
                    
                    <!-- Вид дослідження -->
                    <p class="form-label-print form-line">
                        Вид дослідження: 
                        <span class="print-data ml-1">ЗАГАЛЬНИЙ АНАЛІЗ СЕЧІ</span> <!-- Змінено на СЕЧІ -->
                    </p>

                    <!-- Блок ЛЕЙКОФОРМУЛА ВИДАЛЕНО -->
                    
                    <!-- Підпис лікаря (АВТОМАТИЧНО З ПОЛЯ ЛІКАР) -->
                    <p style="font-size: 10pt !important; margin-top: 2px;">
                        П.І.Б. лікаря 
                        <span class="print-data" style="font-size: 10pt !important;">${data.doctor || ''}</span> 
                        <span class="doctor-signature-line"></span> 
                    </p>
                </div>
            </div>
            `;
        };

        // Шаблон 3: Біохімія - Червоний - ОНОВЛЕНО З ТАБЛИЦЕЮ 6PT
        const templateBiochemistry = (data, index) => {
            
            // Дата взяття біоматеріалу
            const bioDay = data.bioMaterialDay;
            const bioMonthIndex = parseInt(data.bioMaterialMonth) - 1;
            const bioMonthName = monthNames[bioMonthIndex] || '';
            const bioYear = data.bioMaterialYear;
            
            // Масив показників біохімії для формування таблиці
            const biochemistryTests = [
                "Аланінамінотрансфераза (АлАТ)", "Глюкоза",
                "Аспартатамінотрансфераза (АсАТ)", "Залізо",
                "Білірубін загальний", "ЗЗЗС (залізо-зв'язуюча здатність сироватки)",
                "Білірубін прямий", "Феритин",
                "Тимолова проба", "С-реактивний білок",
                "Гамма-глутамілтрансфераза", "Ревматоїдний фактор",
                "Лужна фосфатаза", "Анти-О - стрептолізин",
                "Амілаза", "Сіроглікоїди",
                "Загальний білок", "Магній",
                "Альбумін", "Фосфор",
                "Креатинін", "К (калій)",
                "Сечовина", "Na (натрій)",
                "Сечова кислота", "Кальцій",
                "Загальний холестерин", "Глікований гемоглобін",
                "Тригліцериди", "Інші:",
                "Ліпідограма", "", // Ліпідограма займає окремий рядок
            ];
            
            const tableRows = [];
            for(let i = 0; i < biochemistryTests.length; i += 2) {
                const test1 = biochemistryTests[i];
                const test2 = biochemistryTests[i+1] || '';
                
                tableRows.push(`
                    <div class="biochem-cell empty"></div>
                    <div class="biochem-cell biochem-text">${test1}</div>
                    <div class="biochem-cell empty"></div>
                    <div class="biochem-cell biochem-text">${test2}</div>
                `);
            }


            return `
            <div class="a6-form border-none relative leading-tight">
                <div class="absolute top-[3mm] left-[5mm] right-[5mm]">
                    ${getHeaderHTML(data.institutionName)}

                    <div class="text-center mt-3 mb-2">
                        <p class="mt-1 form-label-print">
                            «<span class="print-field inline w-4 text-center border-none">${bioDay}</span>» <span class="print-field inline w-10 text-center border-none">${bioMonthName}</span> <span class="print-field inline w-8 text-center border-none">${bioYear}</span> р.
                        </p>
                        <p class="text-[7pt] italic">(дата взяття біоматеріалу)</p>
                    </div>
                    
                    <!-- Рядок ПІБ: Підпис + Дані (Жирний, Підкреслений) -->
                    <p class="mt-2 form-label-print form-line">
                        Прізвище,ім'я, по батькові
                        <span class="print-data ml-1">${data.pib}</span>
                    </p>
                    

                    <!-- Дата народження -->
                    <p class="form-label-print form-line">
                        Дата народження (число, місяць, рік)
                        <span class="print-data ml-1">${data.birthDate}</span>
                    </p>
                    
                    <!-- Вік та Стать -->
                    <p class="form-label-print form-line">
                        Вік (повних років) 
                        <span class="print-data ml-1">${data.age}</span> 
                        <span class="ml-2">стать:</span>
                        <span class="print-data ml-1">${data.gender}</span>
                    </p>
                    
                    <!-- Домашня адреса -->
                    <p class="form-label-print form-line">
                        Домашня адреса 
                        <span class="print-data ml-1">${data.address}</span>
                    </p>
                    
                    <!-- Заклад (ФІКСОВАНИЙ ТА СКОРОЧЕНИЙ) -->
                    <p class="form-label-print form-line">
                        Заклад 
                        <span class="print-data ml-1">${SHORT_INSTITUTION_NAME}</span>
                    </p>
                    
                    <!-- Відділення (ФІКСОВАНЕ) -->
                    <p class="form-label-print form-line">
                        Відділення 
                        <span class="print-data ml-1">${data.department}</span>
                    </p>
                    
                    <!-- Лікар -->
                    <p class="form-label-print form-line">
                        Лікар 
                        <span class="print-data ml-1">${data.doctor || ''}</span>
                    </p>
                    
                    <!-- Медична карта № -->
                    <p class="form-label-print form-line">
                        Медична карта № 
                        <span class="print-data ml-1">${data.medCardNumber || ''}</span>
                    </p>
                    
                    <!-- Клінічний діагноз -->
                    <p class="form-label-print form-line">
                        Клінічний діагноз 
                        <span class="print-data ml-1">${data.clinicalDiagnosis || ''}</span>
                    </p>
                    
                    <!-- Таблиця Біохімії (Замість "Вид дослідження" та далі) -->
                    <div class="biochem-table-small">
                        ${tableRows.join('')}
                    </div>
                    
                    <!-- Підпис лікаря (АВТОМАТИЧНО З ПОЛЯ ЛІКАР) -->
                    <p style="font-size: 10pt !important; margin-top: 2px;">
                        П.І.Б. лікаря 
                        <span class="print-data" style="font-size: 10pt !important;">${data.doctor || ''}</span> 
                        <span class="doctor-signature-line"></span> 
                    </p>
                </div>
            </div>
            `;
        };
        
        // Шаблон 4: Коагулограма - Блакитний - ОНОВЛЕНИЙ З ТАБЛИЦЕЮ (2x2)
        const templateCoagulogram = (data, index) => {
            
            // Дата взяття біоматеріалу
            const bioDay = data.bioMaterialDay;
            const bioMonthIndex = parseInt(data.bioMaterialMonth) - 1;
            const bioMonthName = monthNames[bioMonthIndex] || '';
            const bioYear = data.bioMaterialYear;
            
            // Масив показників Коагулограми для формування таблиці (одноколонковий список)
            const coagTests = [
                "МНО", 
                "ПЧ (протромбіновий час)",
                "АЧТЧ (активований частковий тромбопластиновий час)", 
                "ТЧ (тромбіновий час)",
                "Фібриноген",
            ];
            
            // Створення рядків для таблиці (результат + назва)
            const tableRows = coagTests.map(test => `
                <div class="coag-cell empty"></div>
                <div class="coag-cell coag-text">${test}</div>
            `).join('');


            return `
            <div class="a6-form border-none relative leading-tight">
                <div class="absolute top-[3mm] left-[5mm] right-[5mm]">
                    ${getHeaderHTML(data.institutionName)}

                    <div class="text-center mt-3 mb-2">
                        <p class="mt-1 form-label-print">
                            «<span class="print-field inline w-4 text-center border-none">${bioDay}</span>» <span class="print-field inline w-10 text-center border-none">${bioMonthName}</span> <span class="print-field inline w-8 text-center border-none">${bioYear}</span> р.
                        </p>
                        <p class="text-[7pt] italic">(дата взяття біоматеріалу)</p>
                    </div>
                    
                    <!-- Рядок ПІБ: Підпис + Дані (Жирний, Підкреслений) -->
                    <p class="mt-2 form-label-print form-line">
                        Прізвище,ім'я, по батькові
                        <span class="print-data ml-1">${data.pib}</span>
                    </p>
                    


                    <!-- Дата народження -->
                    <p class="form-label-print form-line">
                        Дата народження (число, місяць, рік)
                        <span class="print-data ml-1">${data.birthDate}</span>
                    </p>
                    
                    <!-- Вік та Стать -->
                    <p class="form-label-print form-line">
                        Вік (повних років) 
                        <span class="print-data ml-1">${data.age}</span> 
                        <span class="ml-2">стать:</span>
                        <span class="print-data ml-1">${data.gender}</span>
                    </p>
                    
                    <!-- Домашня адреса -->
                    <p class="form-label-print form-line">
                        Домашня адреса 
                        <span class="print-data ml-1">${data.address}</span>
                    </p>
                    
                    <!-- Заклад (ФІКСОВАНИЙ ТА СКОРОЧЕНИЙ) -->
                    <p class="form-label-print form-line">
                        Заклад 
                        <span class="print-data ml-1">${SHORT_INSTITUTION_NAME}</span>
                    </p>
                    
                    <!-- Відділення (ФІКСОВАНЕ) -->
                    <p class="form-label-print form-line">
                        Відділення 
                        <span class="print-data ml-1">${data.department}</span>
                    </p>
                    
                    <!-- Лікар -->
                    <p class="form-label-print form-line">
                        Лікар 
                        <span class="print-data ml-1">${data.doctor || ''}</span>
                    </p>
                    
                    <!-- Медична карта № -->
                    <p class="form-label-print form-line">
                        Медична карта № 
                        <span class="print-data ml-1">${data.medCardNumber || ''}</span>
                    </p>
                    
                    <!-- Клінічний діагноз -->
                    <p class="form-label-print form-line">
                        Клінічний діагноз 
                        <span class="print-data ml-1">${data.clinicalDiagnosis || ''}</span>
                    </p>
                    
                    <!-- Вид дослідження -->
                    <p class="form-label-print form-line">
                        Вид дослідження: 
                        <span class="print-data ml-1">КОАГУЛОГРАМА</span>
                    </p>

                    <!-- Таблиця Коагулограми (ОНОВЛЕНА) -->
                    <div class="coag-table">
                        ${tableRows}
                    </div>
                    
                    <!-- Підпис лікаря (АВТОМАТИЧНО З ПОЛЯ ЛІКАР) -->
                    <p style="font-size: 10pt !important; margin-top: 2px;">
                        П.І.Б. лікаря 
                        <span class="print-data" style="font-size: 10pt !important;">${data.doctor || ''}</span> 
                        <span class="doctor-signature-line"></span> 
                    </p>
                </div>
            </div>
            `;
        };

        // Шаблон 5: РМП (Серологічний на сифіліс) - Нова форма
        const templateRMP = (data, index) => {
            
            // Дата взяття біоматеріалу
            const bioDay = data.bioMaterialDay;
            const bioMonthIndex = parseInt(data.bioMaterialMonth) - 1;
            const bioMonthName = monthNames[bioMonthIndex] || '';
            const bioYear = data.bioMaterialYear;
            
            return `
            <div class="a6-form border-none relative leading-tight">
                <div class="absolute top-[3mm] left-[5mm] right-[5mm]">
                    ${getHeaderHTML(data.institutionName)}

                    <div class="text-center mt-3 mb-2">
                        <p class="mt-1 form-label-print">
                            «<span class="print-field inline w-4 text-center border-none">${bioDay}</span>» <span class="print-field inline w-10 text-center border-none">${bioMonthName}</span> <span class="print-field inline w-8 text-center border-none">${bioYear}</span> р.
                        </p>
                        <p class="text-[7pt] italic">(дата взяття біоматеріалу)</p>
                    </div>
                    
                    <!-- Рядок ПІБ: Підпис + Дані (Жирний, Підкреслений) -->
                    <p class="mt-2 form-label-print form-line">
                        Прізвище,ім'я, по батькові
                        <span class="print-data ml-1">${data.pib}</span>
                    </p>
                    

                    <!-- Дата народження -->
                    <p class="form-label-print form-line">
                        Дата народження (число, місяць, рік)
                        <span class="print-data ml-1">${data.birthDate}</span>
                    </p>
                    
                    <!-- Вік та Стать -->
                    <p class="form-label-print form-line">
                        Вік (повних років) 
                        <span class="print-data ml-1">${data.age}</span> 
                        <span class="ml-2">стать:</span>
                        <span class="print-data ml-1">${data.gender}</span>
                    </p>
                    
                    <!-- Домашня адреса -->
                    <p class="form-label-print form-line">
                        Домашня адреса 
                        <span class="print-data ml-1">${data.address}</span>
                    </p>
                    
                    <!-- Заклад (ФІКСОВАНИЙ ТА СКОРОЧЕНИЙ) -->
                    <p class="form-label-print form-line">
                        Заклад 
                        <span class="print-data ml-1">${SHORT_INSTITUTION_NAME}</span>
                    </p>
                    
                    <!-- Відділення (ФІКСОВАНЕ) -->
                    <p class="form-label-print form-line">
                        Відділення 
                        <span class="print-data ml-1">${data.department}</span>
                    </p>
                    
                    <!-- Лікар -->
                    <p class="form-label-print form-line">
                        Лікар 
                        <span class="print-data ml-1">${data.doctor || ''}</span>
                    </p>
                    
                    <!-- Медична карта № -->
                    <p class="form-label-print form-line">
                        Медична карта № 
                        <span class="print-data ml-1">${data.medCardNumber || ''}</span>
                    </p>
                    
                    <!-- Клінічний діагноз -->
                    <p class="form-label-print form-line">
                        Клінічний діагноз 
                        <span class="print-data ml-1">${data.clinicalDiagnosis || ''}</span>
                    </p>
                    
                    <!-- Вид дослідження -->
                    <p class="form-label-print form-line">
                        Вид дослідження: 
                        <span class="print-data ml-1">СЕРОЛОГІЧНИЙ НА СИФІЛІС:</span>
                    </p>

                    <!-- Таблиця РМП -->
                    <div class="rmp-table">
                        <div class="rmp-cell empty"></div>
                        <div class="rmp-cell rmp-text">VDRL</div>
                        
                        <div class="rmp-cell empty"></div>
                        <div class="rmp-cell rmp-text">РПГА</div>
                    </div>
                    
                    <!-- Підпис лікаря (АВТОМАТИЧНО З ПОЛЯ ЛІКАР) -->
                    <p style="font-size: 10pt !important; margin-top: 2px;">
                        П.І.Б. лікаря 
                        <span class="print-data" style="font-size: 10pt !important;">${data.doctor || ''}</span> 
                        <span class="doctor-signature-line"></span> 
                    </p>
                </div>
            </div>
            `;
        };
        
        // Шаблон 6: Група крові - Нова форма (Червоний)
        const templateBloodGroup = (data, index) => {
            
            // Дата взяття біоматеріалу
            const bioDay = data.bioMaterialDay;
            const bioMonthIndex = parseInt(data.bioMaterialMonth) - 1;
            const bioMonthName = monthNames[bioMonthIndex] || '';
            const bioYear = data.bioMaterialYear;
            
            return `
            <div class="a6-form border-none relative leading-tight">
                <div class="absolute top-[3mm] left-[5mm] right-[5mm]">
                    ${getHeaderHTML(data.institutionName)}

                    <div class="text-center mt-3 mb-2">
                        <p class="mt-1 form-label-print">
                            «<span class="print-field inline w-4 text-center border-none">${bioDay}</span>» <span class="print-field inline w-10 text-center border-none">${bioMonthName}</span> <span class="print-field inline w-8 text-center border-none">${bioYear}</span> р.
                        </p>
                        <p class="text-[7pt] italic">(дата взяття біоматеріалу)</p>
                    </div>
                    
                    <!-- Рядок ПІБ: Підпис + Дані (Жирний, Підкреслений) -->
                    <p class="mt-2 form-label-print form-line">
                        Прізвище,ім'я, по батькові
                        <span class="print-data ml-1">${data.pib}</span>
                    </p>
                    

                    <!-- Дата народження -->
                    <p class="form-label-print form-line">
                        Дата народження (число, місяць, рік)
                        <span class="print-data ml-1">${data.birthDate}</span>
                    </p>
                    
                    <!-- Вік та Стать -->
                    <p class="form-label-print form-line">
                        Вік (повних років) 
                        <span class="print-data ml-1">${data.age}</span> 
                        <span class="ml-2">стать:</span>
                        <span class="print-data ml-1">${data.gender}</span>
                    </p>
                    
                    <!-- Домашня адреса -->
                    <p class="form-label-print form-line">
                        Домашня адреса 
                        <span class="print-data ml-1">${data.address}</span>
                    </p>
                    
                    <!-- Заклад (ФІКСОВАНИЙ ТА СКОРОЧЕНИЙ) -->
                    <p class="form-label-print form-line">
                        Заклад 
                        <span class="print-data ml-1">${SHORT_INSTITUTION_NAME}</span>
                    </p>
                    
                    <!-- Відділення (ФІКСОВАНЕ) -->
                    <p class="form-label-print form-line">
                        Відділення 
                        <span class="print-data ml-1">${data.department}</span>
                    </p>
                    
                    <!-- Лікар -->
                    <p class="form-label-print form-line">
                        Лікар 
                        <span class="print-data ml-1">${data.doctor || ''}</span>
                    </p>
                    
                    <!-- Медична карта № -->
                    <p class="form-label-print form-line">
                        Медична карта № 
                        <span class="print-data ml-1">${data.medCardNumber || ''}</span>
                    </p>
                    
                    <!-- Клінічний діагноз -->
                    <p class="form-label-print form-line">
                        Клінічний діагноз 
                        <span class="print-data ml-1">${data.clinicalDiagnosis || ''}</span>
                    </p>
                    
                    <!-- Вид дослідження -->
                    <p class="form-label-print form-line">
                        Вид дослідження: 
                        <span class="print-data ml-1">ГРУПА КРОВІ РЕЗУС - ПРИНАЛЕЖНІСТЬ</span>
                    </p>
                
                    <!-- Підпис лікаря (АВТОМАТИЧНО З ПОЛЯ ЛІКАР) -->
                    <p style="font-size: 10pt !important; margin-top: 15px;">
                        П.І.Б. лікаря 
                        <span class="print-data" style="font-size: 10pt !important;">${data.doctor || ''}</span> 
                        <span class="doctor-signature-line"></span> 
                    </p>
                </div>
            </div>
            `;
        };


        // Об'єкт, що містить усі доступні шаблони для динамічного вибору
        const formTemplates = {
            'ZAK': { name: 'ЗАК (Кров)', generator: templateZAK, color: 'bg-purple-500' },
            'ZAS': { name: 'ЗАС (Сеча)', generator: templateZAS, color: 'bg-yellow-500' },
            'KOA': { name: 'Коагулограма', generator: templateCoagulogram, color: 'bg-sky-500' },
            'BLG': { name: 'Група крові', generator: templateBloodGroup, color: 'bg-red-500' }, 
            'RMP': { name: 'РМП (Сифіліс)', generator: templateRMP, color: 'bg-red-500' },
            'BIO': { name: 'Біохімія', generator: templateBiochemistry, color: 'bg-red-500' },
        };
        
        // --- Друк ---
        
        // Функція для розрахунку висоти ряду
        function calculateRowHeight(height1, height2) {
            return Math.max(height1 || 0, height2 || 0);
        }

        // Override old print function
        window.processAndPrint = function() {
            const statusMessage = document.getElementById('status-message');
            console.log("processAndPrint викликано.");

            if (printQueue.length === 0) {
                statusMessage.textContent = "Помилка: Спочатку додайте хоча б один аналіз для друку.";
                statusMessage.classList.remove('text-green-600');
                statusMessage.classList.add('text-red-600');
                return;
            }

            // 1. СОРТУВАННЯ: Біохімія завжди в кінці, інші форми - в порядку додавання
            const bioItems = printQueue.filter(item => item.templateKey === 'BIO');
            const otherItems = printQueue.filter(item => item.templateKey !== 'BIO');
            
            // Об'єднуємо: спочатку всі звичайні, потім всі біохімії
            const sortedQueue = [...otherItems, ...bioItems];

            statusMessage.textContent = "";
            statusMessage.classList.remove('text-red-600');
            statusMessage.classList.add('text-green-600');

            // 2. Підготовка області друку
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = ''; 

            // 3. ЛОГІКА РОЗБИТТЯ НА СТОРІНКИ (ALGORITHM: "Smart Tetris")
            const MAX_PAGE_HEIGHT_MM = 290; // Максимальна висота контенту на A4 (з запасом)
            
            let currentPages = [];
            let currentPage = []; 
            // currentPage = [ {html, height}, ... ]

            // Використовуємо sortedQueue замість printQueue
            for (let i = 0; i < sortedQueue.length; i++) {
                const queueItem = sortedQueue[i];
                const templateKey = queueItem.templateKey;
                const template = formTemplates[templateKey];
                const heightInfo = getFormHeightInfo(templateKey);
                // Генеруємо HTML, передаючи оригінальний номер (хоча він тут не сильно важливий візуально)
                const formHtml = template.generator(queueItem.patientData, i + 1);
                
                const newItem = {
                    html: formHtml,
                    height: heightInfo.height,
                    className: heightInfo.className
                };

                // Перевіряємо, чи влазить новий елемент на поточну сторінку
                // Максимум 4 форми на сторінку (2x2)
                if (currentPage.length < 4) {
                    // Симулюємо додавання
                    const testPage = [...currentPage, newItem];
                    
                    // Розраховуємо висоту рядків
                    // Рядок 1: елементи 0 і 1
                    const row1H = calculateRowHeight(
                        testPage[0] ? testPage[0].height : 0, 
                        testPage[1] ? testPage[1].height : 0
                    );
                    
                    // Рядок 2: елементи 2 і 3
                    const row2H = calculateRowHeight(
                        testPage[2] ? testPage[2].height : 0, 
                        testPage[3] ? testPage[3].height : 0
                    );
                    
                    const totalHeight = row1H + row2H;

                    if (totalHeight <= MAX_PAGE_HEIGHT_MM) {
                        // Влазить! Додаємо.
                        currentPage.push(newItem);
                    } else {
                        // Не влазить по висоті (наприклад, Біохімія штовхає все вниз).
                        // Закриваємо поточну сторінку
                        currentPages.push(currentPage);
                        // Починаємо нову сторінку з цим елементом
                        currentPage = [newItem];
                    }
                } else {
                    // Сторінка заповнена (вже 4 елементи).
                    currentPages.push(currentPage);
                    currentPage = [newItem];
                }
            }
            
            // Додаємо останню сторінку, якщо вона не пуста
            if (currentPage.length > 0) {
                currentPages.push(currentPage);
            }

            // 4. РЕНДЕРИНГ СТОРІНОК
            currentPages.forEach(pageData => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'a4-page';
                
                // Розрахунок висоти рядків для CSS Grid
                const row1H = calculateRowHeight(
                    pageData[0] ? pageData[0].height : 0, 
                    pageData[1] ? pageData[1].height : 0
                );
                const row2H = calculateRowHeight(
                    pageData[2] ? pageData[2].height : 0, 
                    pageData[3] ? pageData[3].height : 0
                );
                
                // Якщо другий рядок порожній, висота 0 (але краще 0mm, щоб не займав місце)
                pageDiv.style.gridTemplateRows = `${row1H}mm ${row2H > 0 ? row2H : 0}mm`;

                pageData.forEach(item => {
                    const formDiv = document.createElement('div');
                    formDiv.className = `a6-form ${item.className}`;
                    formDiv.innerHTML = item.html;
                    pageDiv.appendChild(formDiv);
                });

                printArea.appendChild(pageDiv);
            });

            // 5. Виклик друку
            statusMessage.textContent = "Підготовка до друку...";
            console.log("Викликаємо window.print()...");
            setTimeout(() => {
                window.print();
                statusMessage.textContent = "Дані успішно відформатовані та відправлені на друк.";
            }, 100);
        };
        
        // Функція для автоматичного заповнення поточної дати
        function autoFillDate() {
            const today = new Date();
            // Поточна дата
            document.getElementById('bioMaterialDay').value = String(today.getDate()).padStart(2, '0');
            document.getElementById('bioMaterialMonth').value = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('bioMaterialYear').value = today.getFullYear();
        }
        
        // Функція для автоматичного додавання крапок до дати народження
        function formatBirthDateInput(input) {
            let value = input.value.replace(/\D/g, ''); // Видаляємо всі не-цифри
            
            if (value.length > 8) {
                value = value.substring(0, 8); // Обмежуємо 8 символами
            }

            // dd.mm.yyyy format logic
            let formattedValue = '';
            if (value.length > 0) {
                formattedValue += value.substring(0, 2);
            }
            if (value.length > 2) {
                formattedValue += '.' + value.substring(2, 4);
            }
            if (value.length > 4) {
                formattedValue += '.' + value.substring(4, 8);
            }
            
            input.value = formattedValue;
        }


        // Первинний рендеринг списку при завантаженні
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Ініціалізація випадаючих списків лікарів
            initDoctorSelects();
            
            // 2. Встановлення обробника подій для автоматичного форматування дати народження
            const birthDateInput = document.getElementById('birthDate');
            birthDateInput.addEventListener('input', () => formatBirthDateInput(birthDateInput));

            // 3. Завантаження пацієнтів та автозаповнення поточної дати
            loadPatients();
            autoFillDate(); 

            // 4. Set initial patient data or test data
            const patientKeys = Object.keys(patients);
            if (patientKeys.length > 0) {
                // Вибираємо першого пацієнта, але приховуємо форму (режим перегляду/друку)
                selectPatient(patientKeys[0]); 
                document.getElementById('patient-data-section').classList.add('hidden');
            } else {
                // Set test data defaults if no patients exist
                document.getElementById('pib').value = "Іванов Іван Іванович";
                document.getElementById('birthDate').value = "05.10.1995";
                document.getElementById('age').value = "28";
                document.getElementById('address').value = "Покришева 8, кв 69";
                document.getElementById('medCardNumber').value = "02514";
                document.getElementById('clinicalDiagnosis').value = "хронічний пієлонефрит";
                // Доктор вже встановлений у form.doctor при initDoctorSelects
                // Показуємо форму для нового пацієнта
                document.getElementById('patient-data-section').classList.remove('hidden');
            }

            // 5. Render UI
            renderPatientList();
            renderPrintQueue();
            
            // 6. Set default doctor in quick select to match the form default
            document.getElementById('doctor-quick-select').value = document.getElementById('doctor').value;
        });
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-4 text-center">Генератор Направлень на Аналіз (A6 на A4)</h1>

        <!-- Розділ управління пацієнтами -->
        <div class="bg-blue-100 p-6 rounded-xl mb-8 shadow-2xl border-2 border-blue-300">
            <h2 class="text-xl font-bold text-blue-800 mb-4 flex justify-between items-center">
                1. Управління Пацієнтами
                <span class="text-sm font-normal text-gray-700">Обрано: <span id="current-patient-display" class="font-bold text-blue-900">Не обрано</span></span>
            </h2>
            
            <!-- NEW: Швидкий вибір лікаря -->
            <div class="mb-4">
                <label for="doctor-quick-select" class="form-label text-blue-800">Швидкий вибір лікаря (Змінити для ВСІХ пацієнтів):</label>
                <select id="doctor-quick-select" onchange="handleQuickDoctorChange(this)" class="form-input w-full appearance-none bg-white">
                    <!-- Опції будуть згенеровані JS -->
                </select>
            </div>

            
            <!-- Секція для списку пацієнтів та кнопки "Новий пацієнт" -->
            <div class="mt-4 p-3 bg-white rounded-lg border border-red-300 flex flex-col max-h-72 overflow-y-hidden">
                <p class="text-sm font-medium text-red-700 mb-2">База Пацієнтів (локальне сховище):</p>
                <!-- Контейнер для списку - тепер займає всю висоту, що залишилася -->
                <div id="patient-list-container" class="overflow-y-auto flex-grow">
                    <p class="text-gray-400 italic text-sm">Список пацієнтів...</p>
                </div>
                
                <!-- Кнопка створення нового - ПЕРЕНЕСЕНА ВНИЗ -->
                <button onclick="selectPatient(null)" id="newPatientBtn" class="mt-4 w-full bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition duration-150 shadow-md flex items-center justify-center">
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                    Новий Пацієнт (Очистити форму)
                </button>
            </div>
        </div>
        
        <!-- Розділ введення даних -->
        <div id="patient-data-section" class="bg-indigo-50 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-indigo-800 mb-4">2. Заповнення Даних Пацієнта</h2>
            <form id="entry-form" onsubmit="event.preventDefault();" class="space-y-4">
                <!-- ФІКСОВАНІ ПОЛЯ ВИДАЛЕНО З ФОРМИ -->
                <div class="hidden">
                    <input type="hidden" id="institutionName" name="institutionName" value="${FIXED_INSTITUTION_NAME.replace(/\n/g, ' ')}">
                    <input type="hidden" id="department" name="department" value="${FIXED_DEPARTMENT}">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-3">
                        <label class="form-label">Дата взяття біоматеріалу (Автоматично заповнена поточною датою)</label>
                        <div class="flex space-x-2">
                            <input type="text" id="bioMaterialDay" name="bioMaterialDay" required class="form-input w-1/3" placeholder="ДД" maxlength="2" pattern="\d{2}">
                            <input type="text" id="bioMaterialMonth" name="bioMaterialMonth" required class="form-input w-1/3" placeholder="ММ" maxlength="2" pattern="\d{2}">
                            <input type="text" id="bioMaterialYear" name="bioMaterialYear" required class="form-input w-1/3" placeholder="РРРР" maxlength="4" pattern="\d{4}">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Прізвище, ім'я, по батькові:</label>
                    <input type="text" id="pib" name="pib" required class="form-input w-full" placeholder="Введіть Прізвище Ім'я По батькові">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="birthDate" class="form-label">Дата народження (число, місяць, рік):</label>
                        <input type="text" id="birthDate" name="birthDate" required class="form-input w-full" placeholder="ДД.ММ.РРРР" maxlength="10">
                    </div>
                    <div>
                        <label for="age" class="form-label">Вік (повних років):</label>
                        <input type="number" id="age" name="age" required class="form-input w-full" min="0" placeholder="30">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div>
                        <label class="form-label mb-1">Стать:</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="gender" value="Ч" class="form-radio text-indigo-600" checked>
                                <span class="ml-2">Чоловіча (Ч)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="gender" value="Ж" class="form-radio text-indigo-600">
                                <span class="ml-2">Жіноча (Ж)</span>
                            </label>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label for="address" class="form-label">Домашня адреса:</label>
                        <input type="text" id="address" name="address" required class="form-input w-full" placeholder="Місто, вулиця, будинок">
                    </div>
                </div>
                
                <!-- Додаткові поля з форми -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div>
                        <label for="doctor" class="form-label">Лікар (Випадаючий список - синхронізовано зі Швидким вибором):</label>
                        <!-- Змінено: onchange для синхронізації з quick select -->
                        <select id="doctor" name="doctor" required class="form-input w-full appearance-none bg-white" onchange="document.getElementById('doctor-quick-select').value = this.value;">
                            <!-- Опції будуть згенеровані JS -->
                        </select>
                    </div>
                    <div>
                        <label for="medCardNumber" class="form-label">Медична карта №:</label>
                        <input type="text" id="medCardNumber" name="medCardNumber" class="form-input w-full" placeholder="Номер картки">
                    </div>
                    <div class="md:col-span-2">
                        <label for="clinicalDiagnosis" class="form-label">Клінічний діагноз:</label>
                        <input type="text" id="clinicalDiagnosis" name="clinicalDiagnosis" class="form-input w-full" placeholder="Діагноз">
                    </div>
                </div>
                
                <!-- Лейкоформула (специфічно для ЗАК) -->
                <div class="border-t pt-4">
                    <label class="form-label mb-2">Налаштування специфічні для форм:</label>
                    <div class="flex items-center space-x-6">
                        <p class="font-bold text-gray-700">ЛЕЙКОФОРМУЛА (для ЗАК):</p>
                        <label class="inline-flex items-center">
                            <input type="radio" name="leukoformula" value="yes" class="form-radio text-indigo-600" checked>
                            <span class="ml-2">Так</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="leukoformula" value="no" class="form-radio text-indigo-600">
                            <span class="ml-2">Ні</span>
                        </label>
                    </div>
                </div>
                
                <!-- Додаткова інформація (для старих шаблонів) -->
                <div class="border-t pt-4">
                    <label for="additionalInfo" class="form-label">Додаткова інформація (для інших форм):</label>
                    <textarea id="additionalInfo" name="additionalInfo" rows="2" class="form-input w-full" placeholder="Наприклад: особливі примітки, які будуть використані в інших шаблонах..."></textarea>
                </div>
            </form>
            
            <!-- Кнопка Збереження перенесена сюди -->
            <div class="flex justify-end mt-4">
                <button onclick="saveOrAddPatient()" class="bg-green-600 text-white p-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">
                    <i data-lucide="save" class="w-5 h-5 inline-block mr-1"></i>
                    Зберегти / Оновити Дані Пацієнта
                </button>
            </div>
        </div>
        
        <!-- Розділ вибору шаблонів (Черга друку) -->
        <div class="bg-gray-100 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Додавання Аналізів до Черги (Обрано <span id="selected-forms-count" class="font-bold">0</span>)</h2>
            <p class="text-sm text-gray-600 mb-4">Натисніть на кнопку, щоб додати обраний аналіз для **поточного пацієнта** у чергу друку.</p>

            <div class="flex flex-wrap gap-3 mb-4">
                <button onclick="addToPrintQueue('ZAK')" class="bg-purple-500 text-white p-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-150 shadow-md flex items-center">
                    + ЗАК (Кров)
                </button>
                <button onclick="addToPrintQueue('ZAS')" class="bg-yellow-500 text-gray-800 p-2 rounded-lg font-semibold hover:bg-yellow-600 transition duration-150 shadow-md flex items-center">
                    + ЗАС (Сеча)
                </button>
                <button onclick="addToPrintQueue('KOA')" class="bg-sky-500 text-white p-2 rounded-lg font-semibold hover:bg-sky-600 transition duration-150 shadow-md flex items-center">
                    + Коагулограма
                </button>
                <button onclick="addToPrintQueue('BIO')" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md flex items-center">
                    + Біохімія
                </button>
                <button onclick="addToPrintQueue('RMP')" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md flex items-center">
                    + РМП (Сифіліс)
                </button>
                <button onclick="addToPrintQueue('BLG')" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md flex items-center">
                    + Група крові
                </button>
            </div>
            
            <div class="flex flex-wrap gap-3 mb-4 border-t pt-4">
                <button onclick="undoQueue()" class="bg-orange-500 text-white p-2 rounded-lg font-semibold hover:bg-orange-600 transition duration-150 shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l-7-7 7-7m4 14l7-7-7-7" /></svg>
                    Відмінити останній
                </button>
                <button onclick="clearQueue()" class="bg-gray-500 text-white p-2 rounded-lg font-semibold hover:bg-gray-600 transition duration-150 shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16" /></svg>
                    Очистити чергу
                </button>
            </div>
            
            <div id="selected-forms-container" class="mt-4 p-3 border border-gray-300 rounded-lg min-h-12 bg-white">
                <!-- Сюди буде виводитися список обраних форм --></div>
        </div>
        
        <!-- Кнопка друку -->
        <button onclick="processAndPrint()"
                class="w-full bg-green-600 text-white p-3 rounded-xl font-bold hover:bg-green-700 transition duration-300 shadow-lg flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V4a1 1 0 00-1-1H8a1 1 0 00-1 1v3"></path></svg>
            4. Сформувати Аркуші та Друкувати (A4)
        </button>
        
        <p id="status-message" class="mt-4 text-sm font-medium text-green-600 text-center"></p>

    </div>

    <!-- Область друку - прихована на екрані, активується лише при друці -->
    <div id="print-area" class="print-only hidden">
        <!-- Вміст для друку буде згенеровано тут --></div>

</body>
</html>
